@startuml AutomataBot_Architecture

!theme plain
skinparam backgroundColor #FAFAFA
skinparam class {
    BackgroundColor #E6F3FF
    BorderColor #4A90E2
    ArrowColor #4A90E2
}
skinparam note {
    BackgroundColor #FFF9C4
    BorderColor #FFB74D
}

title AutomataBot - Complete System Architecture\nFinite Automata Theory Telegram Bot with AI Integration

package "Main Entry Point" {
    class Bot_js <<main>> {
        +main()
        +setupBot()
        +connectDatabase()
        +setupHandlers()
        +gracefulShutdown()
        --
        Orchestrates entire application
        Entry point for bot execution
    }
}

package "Core Services" <<Cloud>> {
    
    package "AI Integration" {
        class AIService {
            +callDeepSeekAI(prompt, systemMessage)
            +callDeepSeekAIWithoutThink(prompt, systemMessage)
            +explainAutomataStep(fa, operation, userInput)
            +handleAIQuestion(question)
            +generateLearningContent(topic)
            +handleAIQuestionWithVisuals(question, ctx)
            +generateAutomatonExample(requirement, ctx)
            --
            ğŸ§  Provides AI explanations
            ğŸ¯ Generates practice problems
            ğŸ“š Educational content creation
        }
        
        class TrainAI {
            +generateSystemPrompt()
            +trainOnAutomataTheory()
            --
            ğŸ“ AI training and prompts
            ğŸ“– Knowledge base management
        }
    }
    
    package "Image Generation" {
        class ImageService {
            +generateAutomatonImage(fa, options)
            +createVisualDiagram(automaton)
            +formatDiagramOutput()
            --
            ğŸ¨ Visual automaton diagrams
            ğŸ“Š Chart generation
        }
    }
    
    package "Database Layer" {
        class Database {
            +connectDB()
            +saveToDatabase(userId, input, output, operation)
            +getUserHistory(userId)
            --
            ğŸ’¾ MongoDB operations
            ğŸ“ History tracking
            ğŸ”’ Data persistence
        }
    }
}

package "Command Handlers" <<Component>> {
    class CommandHandlers {
        +handleStart(ctx)
        +handleExplainCommand(ctx)
        +handleExampleCommand(ctx)
        +handleDesignCommand(ctx)
        +handlePracticeCommand(ctx)
        +handleLearningTopic(ctx, topic)
        +handleNaturalLanguageQuestion(ctx, question)
        +handleExamplesCommand(ctx)
        --
        ğŸ¯ Slash command processing
        âŒ¨ï¸ User command routing
    }
}

package "Menu System" <<Component>> {
    class MenuHandlers {
        +handleDesignFA(ctx)
        +handleTestInput(ctx)
        +handleCheckFAType(ctx)
        +handleNFAToDFA(ctx)
        +handleMinimizeDFA(ctx)
        +handleAIHelp(ctx)
        +handleLearnMode(ctx)
        +handleUserHistory(ctx)
        --
        ğŸ”§ Six core features
        ğŸ® Interactive menu system
    }
}

package "Core Algorithms" <<Database>> {
    
    package "Automata Processing" {
        class AutomataUtils {
            +parseDFAInput(text): Object
            +checkFAType(fa): String
            +simulateFA(fa, input): Object
            +nfaToDfa(nfa): Object
            +validateAutomaton(fa): Boolean
            --
            ğŸ”§ FEATURE 1: Design FA parsing
            ğŸ” FEATURE 3: DFA/NFA detection
            ğŸ§ª FEATURE 2: String simulation
            ğŸ”„ FEATURE 4: NFAâ†’DFA conversion
        }
        
        class DFAMinimization {
            +minimizeDFA(dfa): Object
            +partitionRefinement(partitions): Array
            +findEquivalentStates(dfa): Array
            +buildMinimizedDFA(partitions, dfa): Object
            --
            âš¡ FEATURE 5: State minimization
            ğŸ§® Hopcroft's algorithm
            ğŸ“Š Partition refinement
        }
    }
    
    package "Calculator Modules" {
        class DFADesignCalculator {
            +processDesign(input)
            +validateDesign(fa)
            +generateExplanation(fa)
        }
        
        class DFAMinimizationCalculator {
            +processMinimization(dfa)
            +explainMinimization(steps)
            +compareResults(original, minimized)
        }
        
        class FATypeCalculator {
            +analyzeFAType(fa)
            +explainClassification(result)
            +highlightCharacteristics(fa)
        }
        
        class InputTestCalculator {
            +processInputTest(fa, input)
            +simulateExecution(fa, string)
            +generateExecutionTrace(steps)
        }
        
        class NFAToDFACalculator {
            +processConversion(nfa)
            +subsetConstruction(nfa)
            +explainConversionSteps(steps)
        }
        
        class RegexCalculator {
            +regexToAutomaton(regex)
            +automatonToRegex(fa)
            +validateRegexEquivalence(fa, regex)
        }
    }
}

package "Utilities" <<Folder>> {
    class SessionManager {
        +getUserSession(userId): Object
        +updateUserSession(userId, data)
        +clearSession(userId)
        --
        ğŸ“± User state management
        ğŸ”„ Multi-step operations
        ğŸ’­ Context preservation
    }
    
    class MessageFormatter {
        +sendFormattedResult(ctx, result)
        +formatAIResponse(response)
        +formatLearningMessage(topic, content)
        +formatHistoryMessage(history)
        --
        ğŸ’¬ Message beautification
        ğŸ“ Markdown formatting
        ğŸ¨ User-friendly output
    }
}

package "Operation Handlers" <<Component>> {
    class OperationHandlers {
        +processDesignFA(ctx, input)
        +processTestInput(ctx, fa, testString)
        +processCheckType(ctx, fa)
        +processNFAToDFA(ctx, nfa)
        +processMinimizeDFA(ctx, dfa)
        +processAIHelp(ctx, question)
        --
        ğŸ¯ Core feature orchestration
        ğŸ”„ Multi-step workflows
        âœ… Validation and error handling
    }
}

' External Dependencies
cloud "External Services" {
    [Telegram Bot API] as TelegramAPI
    [DeepSeek AI API] as DeepSeekAPI
    [MongoDB Atlas] as MongoDB
}

' Main relationships - Bot orchestration
Bot_js ||--|| CommandHandlers : uses
Bot_js ||--|| MenuHandlers : uses
Bot_js ||--|| Database : connects to
Bot_js --> TelegramAPI : communicates

' Command flow
CommandHandlers --> AIService : requests explanations
CommandHandlers --> ImageService : generates visuals
MenuHandlers --> OperationHandlers : delegates operations

' Core algorithm usage
OperationHandlers --> AutomataUtils : calls algorithms
OperationHandlers --> DFAMinimization : minimizes DFAs
OperationHandlers --> SessionManager : manages state
OperationHandlers --> MessageFormatter : formats output

' Calculator integration
AutomataUtils --> DFADesignCalculator : design processing
AutomataUtils --> InputTestCalculator : simulation
AutomataUtils --> FATypeCalculator : type checking
AutomataUtils --> NFAToDFACalculator : conversion
DFAMinimization --> DFAMinimizationCalculator : minimization
AutomataUtils --> RegexCalculator : regex operations

' Service integrations
AIService --> DeepSeekAPI : AI requests
AIService --> TrainAI : knowledge base
Database --> MongoDB : data persistence
OperationHandlers --> Database : saves results

' Session and formatting
OperationHandlers --> SessionManager : state management
OperationHandlers --> MessageFormatter : response formatting

note top of Bot_js
    **MAIN ENTRY POINT**
    â€¢ Initializes Telegram bot
    â€¢ Sets up middleware and handlers
    â€¢ Connects to MongoDB
    â€¢ Manages graceful shutdown
    â€¢ Orchestrates all components
end note

note top of AIService
    **AI-POWERED FEATURES**
    â€¢ DeepSeek API integration
    â€¢ Natural language processing
    â€¢ Educational explanations
    â€¢ Practice problem generation
    â€¢ Visual diagram creation
end note

note top of AutomataUtils
    **CORE ALGORITHMS**
    ğŸ”§ Feature 1: parseDFAInput()
    ğŸ§ª Feature 2: simulateFA()
    ğŸ” Feature 3: checkFAType()
    ğŸ”„ Feature 4: nfaToDfa()
end note

note top of DFAMinimization
    **MINIMIZATION ENGINE**
    âš¡ Feature 5: minimizeDFA()
    â€¢ Partition refinement algorithm
    â€¢ Hopcroft's optimization
    â€¢ Equivalent state detection
end note

note right of MenuHandlers
    **SIX CORE FEATURES**
    ğŸ”§ Design FA
    ğŸ§ª Test Input
    ğŸ” Check FA Type
    ğŸ”„ NFAâ†’DFA
    âš¡ Minimize DFA
    ğŸ§  AI Help
end note

note left of OperationHandlers
    **WORKFLOW ORCHESTRATION**
    â€¢ Coordinates multi-step operations
    â€¢ Validates user input
    â€¢ Calls appropriate algorithms
    â€¢ Manages error handling
    â€¢ Formats and sends results
end note

' Feature flow annotations
note as N1
    **USER INTERACTION FLOW**
    1. User sends command/menu choice
    2. Handler validates and processes
    3. Algorithm executes computation
    4. AI explains results (optional)
    5. Response formatted and sent
    6. Session state updated
    7. Results saved to database
end note

note as N2
    **SIX MAIN FEATURES IMPLEMENTATION**
    
    ğŸ”§ **DESIGN FA** â†’ parseDFAInput() â†’ Validation â†’ AI explanation
    ğŸ§ª **TEST INPUT** â†’ simulateFA() â†’ Execution trace â†’ Result display
    ğŸ” **CHECK TYPE** â†’ checkFAType() â†’ Classification â†’ Explanation
    ğŸ”„ **NFAâ†’DFA** â†’ nfaToDfa() â†’ Subset construction â†’ Comparison
    âš¡ **MINIMIZE DFA** â†’ minimizeDFA() â†’ Partition refinement â†’ Optimization
    ğŸ§  **AI HELP** â†’ DeepSeek API â†’ Natural language â†’ Educational content
end note

@enduml
